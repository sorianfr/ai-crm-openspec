{% extends "base.html" %}
{% from "_ui/card.html" import card %}

{% block title %}Edit contact - Python CRM{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold text-gray-900 mb-4">Edit contact</h1>
{% if errors %}
<ul class="mb-4 list-disc list-inside text-sm text-red-600">
  {% for err in errors %}
  <li>{{ err }}</li>
  {% endfor %}
</ul>
{% endif %}

{% call card() %}
<form method="post" action="/contacts/{{ contact.id }}">
  {% set name = "full_name" %}{% set label = "Full name" %}{% set type = "text" %}{% set value = form_full_name | default(contact.full_name, true) %}{% set required = true %}
  {% include "_ui/form_field.html" %}
  {% set name = "email" %}{% set label = "Email" %}{% set type = "email" %}{% set value = form_email | default(contact.email or '', true) %}{% set required = false %}
  {% include "_ui/form_field.html" %}
  {% set name = "phone" %}{% set label = "Phone" %}{% set type = "text" %}{% set value = form_phone | default(contact.phone or '', true) %}{% set required = false %}
  {% include "_ui/form_field.html" %}
  {% set name = "company" %}{% set label = "Company" %}{% set type = "text" %}{% set value = form_company | default(contact.company or '', true) %}{% set required = false %}
  {% include "_ui/form_field.html" %}
  <div class="mb-4">
    <label for="company_id" class="block text-sm font-medium text-gray-700 mb-1">Existing company (optional)</label>
    {% set selected_company_id = form_company_id | default(contact.company_id, true) %}
    {% set company_text_prefilled = (form_company | default(contact.company or '', true)) %}
    <select id="company_id" name="company_id" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"{% if company_text_prefilled %} disabled{% endif %}>
      <option value="">-- None --</option>
      {% for company_option in companies %}
      <option value="{{ company_option.id }}" {% if selected_company_id is not none and (selected_company_id | string) == (company_option.id | string) %}selected{% endif %}>{{ company_option.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="flex gap-2">
    {% set name = none %}{% set url = none %}{% set type = "submit" %}{% set label = "Update" %}{% set style = "primary" %}
    {% include "_ui/button.html" %}
    {% set url = "/contacts" %}{% set label = "Cancel" %}{% set style = "secondary" %}
    {% include "_ui/button.html" %}
  </div>
</form>
<script>
(function() {
  var companyInput = document.getElementById('company');
  var companySelect = document.getElementById('company_id');
  if (!companyInput || !companySelect) return;
  function syncDropdown() {
    companySelect.disabled = companyInput.value.trim().length > 0;
  }
  companyInput.addEventListener('input', syncDropdown);
  companyInput.addEventListener('change', syncDropdown);
  syncDropdown();
})();
</script>
{% endcall %}

<section class="notes mt-8">
  <h2 class="text-xl font-semibold text-gray-900 mb-4">Notes</h2>
  <div id="contact-notes-list" class="space-y-2">
    {% for note in notes %}
    {% include "contacts/_note_row.html" %}
    {% endfor %}
  </div>
  {% include "contacts/_add_note_form_container.html" %}
</section>

<section class="activities mt-8">
  <h2 class="text-xl font-semibold text-gray-900 mb-4">Activities</h2>
  <div id="contact-activities-list" class="space-y-2">
    {% for activity in activities|default([]) %}
    {% include "contacts/_activity_row.html" %}
    {% endfor %}
  </div>
  {% include "contacts/_add_activity_form_container.html" %}
</section>
{% endblock %}
